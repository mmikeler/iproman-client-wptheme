# Дано
Тема для Wordpress, предлагает конструктор сайтов с управлением как персональным так и централизованным и разными уровнями доступа от IPRoman.

&nbsp;

## Backend
После авторизации юзер попадает на страницу админки WP, на которой расположено приложение [IPROMAN-ADMIN](https://github.com/mmikeler/iproman-registration-app). Посещать другие страницы админки пользователь не может. Попасть в админку WP можно только через специальный аккаунт с логином **ip_master**.
При первом запуске есть возможность импортировать данные указанные при регистрации или начать заполнение заново.

&nbsp;

## Frontend
Вёрстка на основе Bootstrap 5. Блоки показываются и наполняются согласно настройкам пользователя в админке.

Некоторые разделы, например "Каталог", доступны только пользователям с полной версией админки.
По-умолчанию, когда никакие блоки не заполнены, показывается заглушка.

&nbsp;

# Файлы и каталоги
- `api` // директория API
  - `api.php` // главный файл API админки
  - `error_log.log` // файл логирования ошибок
- `css` // директория стилей темы
  - `animate.css` // анимации
  - `catalog.css` // файл стилей каталога
  - `ip-admin-style.css` // файл стилей админки
  - `response.css` // основной файл media-запросов
  - `style.css` // основной файл стилей
  - `util.css` // вспомогательные стили
- `fonts` // директория шрифтов
- `img` // директория медиафайлов
- `inc` // директория подключаемых файлов 
  - `ajax.php` // код подключения ajax
  - `enqueue.php` // очередь подключения стилей и скриптов
  - `init.php` // код инициализации фронта и админки
  - `options.php` // шаблон страницы админки, настройки, скрипты
  - `technical_notice.php` // шаблон сообщения о технических работах
  - `template_inc.php` // основной файл с компонентами шаблонов
  - `theme_functions.php` // основной файл с функциями темы для работы с данными
  - `theme_update_hook.php` // код для автоматического обновления темы, __не надо трогать__
  - `utilites.php` // вспомогательный код
- `js` // директория скриптов
  - `catalog-custom.js` // кастомные скрипты каталога
  - `custom.js` // кастомные скрипты для фронта
  - `ip-admin-script.js` // кастомные скрипты для админки
- `languages` // директория локализации
  - `localize.php` // главный файл локализации скриптов
  - `.mo` // скомпилированные файлы локализации, используются WP
  - `.po` // файлы для работы в программе __"Poedit"__
- `logs` // директория файлов логов
- `plugin-udate-checker-master` // файлы для автоматического обновления темы, __не надо трогать__
- `static` // директория приложения админки
  - `css` // директория стилей
    - `main.css` // основной файл стилей
  - `js` // директория скриптов
    - `chunk.js` // файл библиотек
    - `main.js` // основной файл приложения
  - `media` // директория медиафайлов
- `templates` // директория шаблонов
  - `default.php` // шаблон заглушки, показывается когда нет заполненых разделов
  - `ip-catalog-tpl.php` // шаблон каталога
- `404.php` // шаблон страницы ошибки
- `footer.php` // шаблон подвала
- `functions.php` // основной файл темы
- `header.php` // шаблон шапки
- `index.php` // базовый файл темы
- `page.php` // базовый шаблон отдельной страницы
- `README.md` // файл описания темы и основных функций
- `screenshot.png` // скриншот темы для отображения в списке тем
- `style.css` // основной файл стилей, содержит информацию о теме

&nbsp;

# Инициализация

`inc/init.php`

При каждой загрузке сайта во время работы в админке проводятся проверки на существование критических элементов:
- наличие таблицы "iproman" в БД , где хранятся все клиентские настройки конструктора;
- наличие мастер-аккаунта;
- наличие контента, предусмотренного расширенной версией конструктора;

Если какой-то элемент отсутствует, то он тут же добавляется.

&nbsp;

# Локализация

В текущей версии WP, шестой, нет возможности корректно работать с локализацией из темы. Поэтому код переключения локализации вынесен в [плагин](https://biz.host/ip-update/packages/iproman_extended.zip).

Локализация в php устанавливается стандартными функциями Wordpress.

Локализация скриптов для фронта и админки реализована в `languages/localize.php`

&nbsp;

# API

Все запросы отправляются по методу POST. Все аргументы являются обязательными, если об этом не сказано отдельно.

Если метод не существует, то будет получен `json` с ключом `code` равным `0`

|action|data|response|error|to do|
|------|----|--------|-----|-----|
|`upload_file`| (file) `file`, (str) `meta_key` | (str) `ID` | - | Загружает пользовательский файл и записывает `ID` загруженного файла в БД согласно `meta_key` |
|`remove_thumb`| (str) `meta_key` | - | - | Заменяет значение указанного мета-поля в БД на пустую строку
|`get_thumb`| (str or num) file_id | (str) `url` | - | Находит и возвращает `url` загруженного файла по его ID
|`update_meta`| (str) `meta_key`, (str) `meta_value` | (int) 1 | (object) WP_Error | Заменят значение указанного мета-поля `meta_key` на указанное `meta_value`. Если такого поля нет, оно будет создано. |
|`ini`| - | (object) { key: value, media: [] } | - | Возвращает `json` со всеми полями таблицы `iproman` + по ключу `media` все `url` загруженных изображений |
|`get_media_collection`| - | (array) [ [url, ID], [url, ID], ... ] | [] | Возвращает `json` массив с массивами `url` и `ID` всех загруженных изображений |
|`IMPORT_REG_DATA`| (any) `options` | (object) { key: value, media: [] } | - | Осуществляет запрос на главный сайт. В случае успеха получает данные, указанные юзером при регистрации и заполняет ими соответствующие поля в БД. Возвращает то же, что `init`.
|`CALL_TO_SUPPORT`| any post data | (str) `ok` | (str) `error` | Формирует из POST данных сообщение в формате `key: value </ br>` и отправляет письмо на адрес администрации главного сайта с этим сообщением. Поле `theme` используется как тема письма.
|`RESET_PASSWORD`| `userID, user_email, theme` | (str) `ok` | (str) `error` | Меняет пароль пользователя и высылает его на `user_email`

&nbsp;

# Работа с таблицей `iproman`

Перечень основных функций для работы с ключевой таблицей БД. Основная директория `inc/theme_functions.php`

|функция|описание|
|-|-|
`get_iproman_options()` | Возвращает все строки таблицы в виде ассоциативного массива.
`update_ip_row(key, value)`| Обновляет значение мета-поля `key` на указанное `value`. Если такого поля нет, оно будет создано.
`get_ip_row(key)` | Возвращает значение мета-поля `key`.
`get_ip_rows()` | Возвращает `json` со всеми полями таблицы + по ключу `media` все `url` загруженных изображений.
`get_ip_field(key)` | Возвращает значение мета-поля `key` с учётом текущей локали.
`update_ip_field(key, value)` | Обновляет значение мета-поля `key` на указанное `value` с учётом текущей локали. Если такого поля нет, оно будет создано.
`the_ip_field(key)` | Возвращает и выводит значение мета-поля `key` с учётом текущей локали.

&nbsp;

# Другие полезные функции

функция | описание
-|-
`isJson(json)` | Проверяет `json` на валидность.
`is_field_valid(fieldNames)` | Проверяет поля на заполнение. Принимает массив имён полей и возвращает `true` - если чекбоксы нажаты и текстовые поля имеют хотя бы один символ, иначе - `false`. Учитывает локализацию.
`get_ip_img_url(id, size)` | Возвращает `url` изображения по `id`. Можно указать размер: `thumb`, `medium`, `full`. По-умолчанию `full`. Если изображение не найдено, возвращается `url` заглушки.
`ip_img_url(id, size)` | Возвращает и выводит `url` изображения по `id`. Можно указать размер: `thumb`, `medium`, `full`. По-умолчанию `full`. Если изображение не найдено, возвращается `url` заглушки.
`is_user_vip()` | Возвращает `true` если пользователь активировал полную версию конструктора и `false` если нет.

&nbsp;

# Важные поля в БД

Есть мета-поля с указанием локали, например `s1_1[en_US]` и без - `_ip_user_level`. Поля с локалью проще получать при помощи функции `get_ip_field`, которая учитывает локаль. А вот поля без локали можно получить только при помощи `get_ip_row`.

Мета-поле | Тип значения | Описание
-|-|-
`_ip_user_level` | str | Уровень аккаунта пользователя. `default` или `vip`
`_start_synch_date` | number | Дата переноса регистрационных данных с главного сайта на сайт клиента. Чтобы повторить процедуру, необходимо очистить это поле.
`admin_locale` | str | Локаль админки в полном формате, например `en_US`.
`IPKEY` | str | Код пользователя. Обязательно должно быть установлено перед переносом данных с главного сайта. Так же используется при запросах на главный сайт.
`site_languages` | str | Активные локали на сайте. Перечисляются через запятую. В коде используется через `php explode`.